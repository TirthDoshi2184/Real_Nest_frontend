import React, { useEffect, useState } from 'react';
import { Grid, Card, CardContent, CardMedia, Typography, TextField, Box, Button, Select, MenuItem, styled } from '@mui/material';
import { useDispatch, useSelector } from 'react-redux';
import axios from 'axios';
import { Link, useNavigate } from 'react-router-dom';
import { setCities, setSelectedCity, fetchCities } from '../Redux/CityFilter';
// import { setCities, setSelectedCity, fetchCities } from './CityFilter';
import 'bootstrap/dist/css/bootstrap.min.css';
import { Modal } from 'react-bootstrap';

const cardStyles = {
  root: {
    maxWidth: 260,
    margin: 'auto',
    marginBottom: 20,
  },
  media: {
    height: 140,
  },
};

const ListProperty = () => {
  const [properties, setProperties] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const cities = useSelector((state) => state.city.cities);
  const selectedCity = useSelector((state) => state.city.selectedCity);
  const dispatch = useDispatch();
  const navigate = useNavigate();

   const [show, setShow] = useState(false);
  const handleClose = () => setShow(false);
  const handleShow = () => setShow(true);


  useEffect(() => {
    dispatch(fetchCities());
  }, [dispatch]);

  useEffect(() => {
    const fetchProperties = async () => {
      try {
        let url = "http://localhost:3000/flat/getflat";
        if (selectedCity) {
          url += ?city=${selectedCity};
        }
        const response = await axios.get(url);
        setProperties(response.data.data);
      } catch (error) {
        console.error("Error fetching properties:", error);
      }
    };

    fetchProperties();
  }, [selectedCity]);

  const handleSearchChange = (event) => {
    setSearchQuery(event.target.value);
  };

  const handleCityChange = (event) => {
    const selectedCity = event.target.value;
    dispatch(setSelectedCity(selectedCity));
  };

  const handleAddProperty = () => {
    navigate("/user/addproperty");
  };

  const handleLogin = () => {
    navigate("/login");
  };
  const handleViewProperty = (propertyId) => {
    navigate(/pdetail/${propertyId});
  };





  const filteredProperties = properties.filter(property =>
    property?.society?.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    property?.price?.toString().toLowerCase().includes(searchQuery.toLowerCase()) ||
    property?.user?.role
  );
  return (
    <div>
      <Box sx={{ bgcolor: '#f0f0f0', padding: '10px 20px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
        <Typography variant="h6" component="div">
          Company Name
        </Typography>
        <Box sx={{ display: 'flex', alignItems: 'center' }}>
          <Select
            value={selectedCity}
            onChange={handleCityChange}
            variant="outlined"
            style={{ marginRight: 10 }}
          >
            <MenuItem value="">Select City</MenuItem>
            {cities?.map((city) => (
              <MenuItem key={city.id} value={city._id}>
                {city.city}
              </MenuItem>
            ))}
          </Select>
          <Button variant="contained" color="primary" onClick={handleAddProperty} style={{ marginRight: 10 }}>
            Add Property
          </Button>
          <Button variant="outlined" color="primary" onClick={handleLogin}>
            Login
          </Button>
        </Box>
      </Box>

      <TextField
        label="Search Properties"
        variant="outlined"
        fullWidth
        value={searchQuery}
        onChange={handleSearchChange}
        style={{ marginBottom: 20, marginTop: 10 }}
      />

      <Grid container spacing={2}>
        {filteredProperties.map((pr) => (
          <Grid item xs={6} sm={4} md={3} lg={2} key={pr?._id}>
            <Card style={cardStyles.root}>
              <CardMedia
                style={cardStyles.media}
                image={pr?.imgUrl}
                title={pr?.society?.name || 'Property Image'}
              />
              <CardContent>
                <Typography gutterBottom variant="h6" component="h2">
                  {pr?.type || 'Flat type'}
                </Typography>
                <Typography variant="body2" color="textSecondary" component="p">
                  {pr?.price ? Price: ${pr.price} : 'Price not available'} ,
                  {pr?.location}
                </Typography>
                <Typography>

                </Typography><br />
                  <Button style={{ padding: '10px 10px', marginLeft: '.7rem', borderRadius: "3px", fontSize: '16px', cursor: 'pointer', color: 'white', backgroundColor: 'blue', border: 'none' }} onClick={handleShow}>
            Contact Owner
          </Button>
          <Modal show={show} onHide={handleClose}>
            <Modal.Header closeButton>
              <Modal.Title>Owner Details</Modal.Title>
            </Modal.Header>
            <Modal.Body>OWNER NAME : {singleflat.data?.user?.fullname || "No Name Available"}</Modal.Body>
            <Modal.Body>Contact No: {singleflat?.data?.user?.mobileNo || "No Contact Available"}</Modal.Body>
            <Modal.Body>Area : {singleflat?.data?.location} , {singleflat?.data?.interiorType}</Modal.Body>
          <Modal.Footer>
            <Button variant="secondary" onClick={handleClose}>
              Contact 
            </Button>
            <Button variant="primary" onClick={handleClose}>
              Close
            </Button>
          </Modal.Footer>
        </Modal>

              </CardContent>
            </Card>
          </Grid>
        ))}
      </Grid>
    </div>
    
  );
};

export default ListProperty;